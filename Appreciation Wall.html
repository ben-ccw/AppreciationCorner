<!DOCTYPE html>
<!-- (新) 更改 lang 為 'en' -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- (新) 更改為雙語標題, 移除 | -->
    <title>Appreciation Wall 感謝牆</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- (新) 加入 Tailwind 設定以擴展企業顏色 -->
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                'company-red': '#C0392B',
                'company-green': '#27AE60',
              }
            }
          }
        }
    </script>
    <style>
        /* 使用一個更柔和的字體 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5; /* 柔和的背景色 */
        }
        /* 針對不同核心價值的標籤顏色 */
        .tag {
            /* (新) 調整垂直 padding, 文字置中, 調整行高 */
            padding: 6px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
            margin-top: 4px;
            margin-right: 4px; 
            text-align: center;
            line-height: 1.3;
        }
        .tag-accountability { background-color: #dbeafe; color: #1d4d8; }
        .tag-creativity { background-color: #e8dffc; color: #5b21b6; }
        /* (新) 更新 Empathy 顏色以符合 #27AE60 */
        .tag-empathy { background-color: rgba(39, 174, 96, 0.1); color: #27AE60; }
        .tag-integrity { background-color: #fef9c3; color: #854d0e; }
        /* (新) 更新 Teamwork 顏色以符合 #C0392B */
        .tag-teamwork { background-color: rgba(192, 57, 43, 0.1); color: #C0392B; }

        /* (已移除) 走馬燈 CSS (marquee-container, @keyframes 等) */

        /* (新) 載入中動畫 */
        .loader {
            border: 6px solid #f3f3f3; /* 淺灰色 */
            border-top: 6px solid #C0392B; /* 企業紅色 */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 40px auto; /* 上下邊距 40px 並水平置中 */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto px-4 py-6">
        
        <!-- (新) 容器 ID 已更改，並移除了走馬燈的特定樣式 -->
        <div class="wall-container" id="wall-container">
            <!-- 感謝卡片將會被動態插入到這裡 -->
            <div id="appreciation-wall" class="flex flex-col gap-3">
                <!-- (新) 載入中動畫, 會在資料載入後自動被清除 -->
                <div id="loader" class="loader"></div>
            </div>
        </div>

    </div>

    <script>
        // --- (修正) 範例資料 (Demo Data) 已被移除 ---
        // const demoData = [ ... ];

        // --- JavaScript 動態載入 ---

        let allRecords = []; // 用來儲存所有從 Power Automate 取得的資料
        let wallElement;
        // (已移除) containerElement

        document.addEventListener('DOMContentLoaded', () => {
            wallElement = document.getElementById('appreciation-wall');
            // (已移除) containerElement 初始化
            
            // --- (修正) 已停用 Demo Data 載入 ---
            // allRecords = demoData;
            // loadAllRecords(allRecords);

            // --- 
            // *** (修正) 真實串接已啟用 ***
            
            const powerAutomateUrl = 'https://defaultee852185feb2443884e299a17193b8.f2.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/adaf532a1d9943efb315238399766cff/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=YFVJFgBorB6ocngHBqU11tQS_QYDNClu6cEbGfp1yNo';

            fetch(powerAutomateUrl, {
                method: 'POST', // Power Automate HTTP 觸發器通常預設為 POST
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // 假設 Power Automate 回傳的格式是 { "value": [...] } 或直接是 [...]
                const records = Array.isArray(data) ? data : data.value;

                // (修正) 確保在載入新資料前，清空感謝牆
                wallElement.innerHTML = ''; 
                
                allRecords = records;
                loadAllRecords(allRecords); 
            })
            .catch(error => {
                console.error('載入感謝資料時發生錯誤:', error);
                // (新) 雙語錯誤訊息, 移除 |
                wallElement.innerHTML = '<p class="text-red-500">Unable to load data, please try again later. 無法載入資料，請稍後再試。</p>';
            });
            // --- 
        });

        /**
         * (新) 簡化版的載入函式，已移除走馬燈邏IC
         */
        function loadAllRecords(data) {
            if (!data || data.length === 0) {
                // (新) 雙語提示, 移除 |
                wallElement.innerHTML = '<p class="text-gray-500">No public appreciation messages found. 目前沒有公開的感謝訊息。</p>';
                return;
            }

            // 1. 載入原始記錄
            data.forEach(item => {
                const card = createCardElement(item);
                wallElement.appendChild(card);
            });

            // (已移除) 檢查溢出、複製內容、啟動動畫的
        }
        
        /**
         * 建立單個卡片 DOM 元素 (緊湊型設計)
         */
        function createCardElement(item) {
            const card = document.createElement('article');
            card.className = 'bg-white rounded-lg shadow-md overflow-hidden transition-all duration-300 hover:shadow-xl';

            // 處理 SharePoint List 傳回的實際欄位名稱
            const recipient = item.RecipientText || 'N/A';
            const sender = item.SenderText || 'N/A';
            const content = item.Content || '';
            const elements = item.Elements || [];
            const date = item.Date || item.Created; // 嘗試使用 Date，否則使用 Created

            const elementTags = getElementTags(elements);

            // (新) 調整版面：將 elementTags 移到 recipient 下方
            // (新) 調整標籤為雙語並使用企業顏色
            card.innerHTML = `
                <div class="p-4 flex flex-col md:flex-row md:items-start md:gap-4">
                    <!-- Left Side: Main Content -->
                    <div class="flex-grow">
                        <!-- (新) 使用 company-red 並改為雙語, 移除分隔符號與重複的名字 -->
                        <!-- (新) 文字大小改為 text-sm -->
                        <h3 class="text-sm font-bold text-company-red mb-1">To 給： ${recipient}</h3>
                        
                        <!-- (已移除) 元素標籤從這裡移走 -->
                        
                        <!-- (新) 文字大小改為 text-sm -->
                        <p class="text-sm text-gray-700">"${content}"</p>

                        <!-- (新) 元素標籤移到留言下方, 並增加上邊距 -->
                        <div class="flex flex-wrap mt-3">
                            ${elementTags}
                        </div>
                    </div>
                    
                    <!-- Right Side: Metadata -->
                    <!-- (新) 將 md:w-1/4 更改為 md:w-1/3 -->
                    <div class="md:w-1/3 md:flex-shrink-0 md:text-right mt-4 md:mt-0 pt-4 md:pt-0 border-t md:border-t-0 md:border-l md:pl-4">
                        <!-- (已移除) 元素標籤從這裡移走 -->
                        
                        <footer class="mt-2 text-left md:text-right">
                            <!-- (新) 使用 company-green 並改為雙KOK, 移除分隔符號與重複的名字 -->
                            <p class="text-sm text-company-green font-medium">From 來自： ${sender}</p>
                            <time class="text-xs text-gray-400">${formatDate(date)}</time>
                        </footer>
                    </div>
                </div>
            `;
            return card;
        }


        /**
         * 根據 Elements 欄位回傳對應的 HTML 標籤樣式 (支援多選)
         */
        function getElementTags(elements) {
            if (!elements) return ''; 

            // SharePoint Choice 欄位 (允許多選) 會回傳一個陣列
            const elementsArray = Array.isArray(elements) ? elements : [elements];

            return elementsArray.map(element => {
                // 處理 element 可能是物件的情況 (SharePoint Choice 常見)
                const value = (typeof element === 'object' && element.Value) ? element.Value : element;
                
                let tagClass = '';
                // (新) 增加 translation 變數
                let translation = '';
                
                switch(value) {
                    case 'Accountability':
                        tagClass = 'tag-accountability';
                        translation = '承擔責任';
                        break;
                    case 'Creativity':
                        tagClass = 'tag-creativity';
                        translation = '具創造力';
                        break;
                    case 'Empathy':
                        tagClass = 'tag-empathy';
                        translation = '同理心';
                        break;
                    case 'Integrity':
                        tagClass = 'tag-integrity';
                        translation = '堅守誠信';
                        break;
                    case 'Teamwork':
                        tagClass = 'tag-teamwork';
                        translation = '團隊合作';
                        break;
                    default:
                        tagClass = 'bg-gray-200 text-gray-700'; 
                        translation = value; // Fallback
                }
                // (新) 回傳雙語分行格式
                return `<span class="tag ${tagClass}">${value}<br>${translation}</span>`;
            }).join(' '); 
        }

        /**
         * 格式化日期
         */
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                // 檢查是否為無效日期
                if (isNaN(date.getTime())) {
                    return dateString; // 回傳原始字串
                }
                return date.toISOString().split('T')[0];
            } catch (e) {
                return dateString; // 解析錯誤時回傳原始字 stran
            }
        }

    </script>

</body>
</html>


